<!DOCTYPE html>
<!--
TODO
encrypt (scrypt, aes), TLS (https://github.com/digitalbazaar/forge)
omxplayer -o local http://mp3.streampower.be/radio1-mid.mp3
Helderheid display automatisch regelen via lichtmeting met camera
-->
<html>
  <head>
    <meta charset="UTF-8">
    <title>PindaNet Raspberry Pi</title>
    <style type="text/css">
      html {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      body {
        background-size: cover;
        min-height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        -moz-transition: background 1.5s linear;
        transition: background 1.5s linear;
        opacity: 1.0;
      }
      th, .dayname {
        color: white;
        text-shadow: 0 0 2px black;
        text-align: center;
        text-decoration: none;
        font-size: 20px;
        font-weight: bold;
      }
      .inline {
        display: inline-block;
        vertical-align: middle;
      }
      #content {
        position: absolute;
        transition: 1s;
        text-align: center;
      }
      button {
        background-color: rgba(128,128,128,0.5);
        border: 1px solid rgb(128,128,128);
        color: white;
        padding: 15px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        font-weight: bold;
        border-radius: 12px;
        box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
      }
      td button {
        padding: 10px;
      }
      #clock {
        color: white;
        font-size: 150px;
        text-shadow: 0 0 2px black;
      }
      #bme280 {
        color: white;
        font-size: 30px;
        text-shadow: 0 0 2px black;
      }
      #date {
        color: white;
        font-size: 45px;
        text-shadow: 0 0 2px black;
      }
      .terminalbox {
        background-color: rgba(0,0,0,0.5);
        border: 1px solid rgb(128,128,128);
        border-radius: 12px;
        box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
/*         margin: 3.5%; */
        width: 92%;
        padding: 1em;
        text-align: left;
        color: #fff;
        text-shadow: 0 0 2px black;
      }
      /* PinPad */
      #PINform input:focus,
      #PINform select:focus,
      #PINform textarea:focus,
      #PINform button:focus {
        outline: none;
      }
      #PINform {
        position: absolute;
        width: 300px; height: 400px;
        left: 50%;
        margin-left: -180px;
        top: 50%;
        margin-top: -215px;
        padding: 30px;
      }
      #PINbox {
        background-color: rgba(128,128,128,0.5);
        border: 1px solid rgb(128,128,128);
        border-radius: 12px;
        box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
        margin: 3.5%;
        width: 92%;
        font-size: 3em;
        text-align: center;
        color: #fff;
        text-shadow: 0 0 2px black;
      }
      .PINbutton {
        background-color: rgba(128,128,128,0.5);
        border: 1px solid rgb(128,128,128);
        box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
        color: #fff;
        text-shadow: 0 0 2px black;
        font-weight: bold;
        border-radius: 50%;
        font-size: 1.5em;
        text-align: center;
        width: 60px;
        height: 60px;
        margin: 7px 20px;
        padding: 0;
      }
      .clear, .enter {
        font-size: 1em;
      }
      .PINbutton:hover {
        box-shadow: #506CE8 0 0 1px 1px;
      }
      .PINbutton:active {
        background: rgba(80,108,232,0.5);
        color: #fff;
      }
      .clear:hover {
        box-shadow: #ff3c41 0 0 1px 1px;
      }
      .clear:active {
        background: rgba(255,60,65,0.5);
        color: #fff;
      }
      .enter:hover {
        box-shadow: #47cf73 0 0 1px 1px;
      }
      .enter:active {
        background: rgba(71,207,115,0.5);
        color: #fff;
      }
      /* End PinPad */
    </style>
    <!--script src="sha.js"></script-->
    <script src="jsencrypt.js"></script>
    <script type="text/javascript">
    // PinPad
      function addNumber(event, element){
        document.getElementById('PINbox').value = document.getElementById('PINbox').value+element.value;
        event.stopPropagation();
      }
      function clearForm(event){
        document.getElementById('PINbox').value = "";
        event.stopPropagation();
      }
      var encryptedPIN="";
      var pubkey;
      var callback;
      function submitForm(event) {
        if (document.getElementById('PINbox').value == "") {
          alert("PINcode invoeren");
        } else {
          // Encrypt with the public key...
          var encrypt = new JSEncrypt();
          encrypt.setPublicKey(pubkey);
          encryptedPIN = encrypt.encrypt(document.getElementById('PINbox').value);
          document.getElementById('PINbox').value="";
          document.getElementById("content").innerHTML = "";
          callback(event);
        }
        event.stopPropagation();
      }
      function enterPIN(event) {
        document.getElementById("content").innerHTML = '<pre class="terminalbox">Even geduld...</pre>';
        centerContent();
        event.stopPropagation();
        var xhr = new XMLHttpRequest();
        xhr.open('POST', "bash.sh", true);
        xhr.onload = function(e) {
          if (this.status == 200) {
            pubkey = this.responseText;
            document.getElementById("content").innerHTML = `<form action="" method="" name="PINform" id="PINform" autocomplete="off"><input id="PINbox" value="" name="PINbox" disabled="" type="password"><br><input class="PINbutton" name="1" value="1" id="1" onclick="addNumber(event, this);" type="button"><input class="PINbutton" name="2" value="2" id="2" onclick="addNumber(event, this);" type="button"><input class="PINbutton" name="3" value="3" id="3" onclick="addNumber(event,this);" type="button"><br><input class="PINbutton" name="4" value="4" id="4" onclick="addNumber(event,this);" type="button"><input class="PINbutton" name="5" value="5" id="5" onclick="addNumber(event,this);" type="button"><input class="PINbutton" name="6" value="6" id="6" onclick="addNumber(event,this);" type="button"><br><input class="PINbutton" name="7" value="7" id="7" onclick="addNumber(event,this);" type="button"><input class="PINbutton" name="8" value="8" id="8" onclick="addNumber(event,this);" type="button"><input class="PINbutton" name="9" value="9" id="9" onclick="addNumber(event,this);" type="button"><br><input class="PINbutton clear" name="-" value="clear" id="-" onclick="clearForm(event);" type="button"><input class="PINbutton" name="0" value="0" id="0" onclick="addNumber(event,this);" type="button"><input class="PINbutton enter" name="+" value="enter" id="+" onclick="submitForm(event);" type="button"></form>`;
            centerContent();
            event.stopPropagation();
          }
        };
        xhr.send("command=genkey");
      }
    // End PinPad

      function setcursor() {
        if (window.location.hostname == "localhost") {
          document.body.style.cursor = "url(nocursor.gif), auto";
        } else {
          document.body.style.cursor = "default";
        }
      }
      function background() {
        if (encryptedPIN != "") {
          encryptedPIN="";
          document.getElementById("content").innerHTML = "";
        }
        var xhr = new XMLHttpRequest();
        xhr.open('POST', "background.sh", true);
        xhr.onload = function(e) {
          if (this.status == 200) {
            var imageFileName = this.responseText;
            document.body.style.backgroundImage = 'url(background/' + imageFileName + ')';
            startBackgroundTimer = setTimeout(background, 864000);
          }
        };
        xhr.send();
      }
      function centerContent() {
        document.getElementById("content").style.top = (window.innerHeight - document.getElementById("content").offsetHeight)/2 + "px";
        document.getElementById("content").style.left = (window.innerWidth - document.getElementById("content").offsetWidth)/2 + "px";
      }
      var hourly = 0;
      function weather(event) {
        if(++hourly > 59) {
          hourly = 0;
          document.getElementById("content").innerHTML = `<img src="https://www.yr.no/place/Belgium/Flanders/Bruges/meteogram.png" alt="Weerbericht Brugge" height="272" width="828" onclick="menu();">
          <p id="bme280"></p>`;
        }
        var xhr = new XMLHttpRequest();
        xhr.open('POST', "bme280.sh", true);
        xhr.onload = function(e) {
          if (this.status == 200) {
            document.getElementById("bme280").innerHTML = this.responseText;
            centerContent();
            startTimer = setTimeout(weather, 60000);
          }
        };
        xhr.send();
        event.stopPropagation();
      }
      function motionDetection(event) {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', "motion.sh", true);
        xhr.onload = function(e) {
          if (this.status == 200) {
            motionPhotos = JSON.parse(this.responseText);
            document.getElementById("content").innerHTML = `      
            <div style="height: 480px; width: 800px; background-image: url('motion/fotos/` + motionPhotos[1] + `');">
            <p>Dit is een test.</p>
            </div>`
            centerContent();
            event.stopPropagation();
          }
        };
        xhr.send();
      }
var thermostat = "";
loadThermostat();
      function saveThermostat() {
      // sorteer op tijd
        for (var day = 0; day < 7; day++) {
          thermostat[day].sort(function(a,b) {
            return a.time > b.time;
          });
        }
        var xhr = new XMLHttpRequest();
        xhr.open('POST', "bash.sh", true);
        xhr.onload = function(e) {
          if (this.status == 200) {
            getThermostatTemp();
          }
        };
        xhr.send("command=saveThermostat&json=" + btoa(JSON.stringify(thermostat)));
      }
      function exportThermostat(event) {
        window.open("exportthermostat.sh");
        event.stopPropagation();
      }
      function loadThermostat() {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', "thermostat.sh", true);
        xhr.onload = function(e) {
          if (this.status == 200) {
            if (thermostat == "") {
              thermostat = JSON.parse(atob(this.responseText));
            }
            if (window.location.hostname == "localhost") { // enkel lokaal
              thermostatTimer = setTimeout(loadThermostat, 300000);
            }
          }
        };
        xhr.send();
      }
      function importThermostat(event) {
        document.getElementById("content").innerHTML = `      
        <form class="terminalbox" id="jsonFile" name="jsonFile" enctype="multipart/form-data" method="post">
            <h2 style="text-align: center;">Thermostaat importeren</h2>
            <input type='file' id='fileinput' onclick="event.stopPropagation();">
            <input type='button' id='btnLoad' value='Laden' onclick='loadFile();'>
        </form>`
        centerContent();
        event.stopPropagation();
      }
      function loadFile() {
        var input, file, fr;

        if (typeof window.FileReader !== 'function') {
          alert("The file API isn't supported on this browser yet.");
          return;
        }

        input = document.getElementById('fileinput');
        if (!input) {
          alert("Um, couldn't find the fileinput element.");
        }
        else if (!input.files) {
          alert("This browser doesn't seem to support the `files` property of file inputs.");
        }
        else if (!input.files[0]) {
          alert("Please select a file before clicking 'Load'");
        }
        else {
          file = input.files[0];
          fr = new FileReader();
          fr.onload = receivedText;
          fr.readAsText(file);
        }
      }
      function receivedText(e) {
        lines = e.target.result;
        thermostat = JSON.parse(lines);
        weeklyThermostat(e);
      }

      function outputUpdate(event, value, elmid, day, timetemp) {
        document.getElementById(elmid).value = ("0" + value).slice(-2);
        thermostat[day][timetemp].time = document.getElementById("sethour").value + ":" + document.getElementById("setmin").value;
        thermostat[day][timetemp].temp = document.getElementById("settemp").value;
        event.stopPropagation();
      }
      function setThermostat(event, day, timetemp) {
          document.getElementById("content").innerHTML = `<div class="dayname">
          <button onclick="weeklyThermostat(event);">&#x25C0;</button> ` +
          dayNames[day] + ` <input type="text" size="2" id="sethour" onchange="outputUpdate(event,value,'sethour',` + day + `,` + timetemp + `)" onclick="event.stopPropagation();" value="` + thermostat[day][timetemp].time.substring(0, 2) + `">
          <input class="inline" type="range" orient="vertical" min="0" max="23" oninput="outputUpdate(event,value,'sethour',` + day + `,` + timetemp + `)" onclick="event.stopPropagation();" value="` + thermostat[day][timetemp].time.substring(0, 2) + `">

          <input type="text" size="2" id="setmin" onchange="outputUpdate(event,value,'setmin',` + day + `,` + timetemp + `)" onclick="event.stopPropagation();" value="` + thermostat[day][timetemp].time.substring(3, 5) + `">
          <input class="inline" type="range" orient="vertical" min="0" max="59" oninput="outputUpdate(event,value,'setmin',` + day + `,` + timetemp + `)" onclick="event.stopPropagation();" value ="` + thermostat[day][timetemp].time.substring(3, 5) + `">

          <input type="text" size="2" id="settemp" onchange="outputUpdate(event,value,'settemp',` + day + `,` + timetemp + `)" onclick="event.stopPropagation();" value="` + thermostat[day][timetemp].temp + `"> °C
          <input class="inline" type="range" orient="vertical" min="0" max="24" oninput="outputUpdate(event,value,'settemp',` + day + `,` + timetemp + `)" onclick="event.stopPropagation();" value="` + thermostat[day][timetemp].temp + `">

          <button onclick="delTimeTemp(event,` + day + `,` + timetemp + `);">&mdash;</button></div>`;
          event.stopPropagation();
      }
      function addTimeTemp(event, day, timetemp) {
        thermostat[day].push({"time": "23:59", "temp":"15"});
        weeklyThermostat(event);
        event.stopPropagation();
      }
      function delTimeTemp(event,day, timetemp) {
        thermostat[day].splice(timetemp, 1);
        weeklyThermostat(event);
      }
      function getThermostatTemp() {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', "thermostat.sh", true);
        xhr.onload = function(e) {
          if (this.status == 200) {
            thermostat = JSON.parse(atob(this.responseText));
            
            tableel='<table style="width:790px">';
            tableel+='<tr>';
            for (var day = 0; day < 7; day++) {
              tableel += '<th>' + dayNames[day] + '</th>';
            }
            tableel+='</tr>';
            timetemp=0;
            timetempvalues=true;
            while (timetempvalues) {
              timetempvalues=false;
              tableel+='<tr>';
            for (var day = 0; day < 7; day++) {
                if (typeof thermostat[day][timetemp] !== 'undefined') {
                  tableel += '<td><button onclick="setThermostat(event,' + day + ',' + timetemp + ');">' + thermostat[day][timetemp].time + ' ' + thermostat[day][timetemp].temp + '°C</button></td>';
                  timetempvalues=true;
                } else if (typeof thermostat[day][timetemp - 1] !== 'undefined' || timetemp == 0) {
                    tableel += '<td><button onclick="addTimeTemp(event,' + day + ',' + timetemp + ');">++:++ ++°C</button></td>';
                } else {
                  tableel += '<td></td>';
                }
              }
              tableel+='<tr>';
              timetemp++;
            }
            tableel+='</table>';
            tableel+='<div style="text-align: left;">';
            tableel+=' <button id="onThermostat" onclick="onThermostat(event);">Aan</button>';
            tableel+=' <button id="offThermostat" onclick="offThermostat(event);">Uit</button>';
            tableel+=' <button id="autoThermostat" onclick="autoThermostat(event);">Auto</button>';
            tableel+=' <span class="terminalbox"><span id="thermostatTemp">Regeltemp: 5 °C</span></span>';
            tableel+=' <span class="terminalbox"><span id="roomTemp">Kamertemp: 5 °C</span></span>';
            tableel+=' <button id="resetThermostat" onclick="resetThermostat(event);">Reset</button>';
            tableel+=' <button title="Opslaan" onclick="exportThermostat(event);">&DownArrowBar;</button>';
            tableel+=' <button title="Laden" onclick="importThermostat(event);">&UpArrowBar;</button>';
            tableel+='</div>';
            document.getElementById("content").innerHTML = tableel;
            centerContent();

            if (thermostat[7].manual == "Off") {
              document.getElementById("autoThermostat").style = "color: black;";
              document.getElementById("thermostatTemp").innerHTML = "Regeltemp: " + thermostat[7].controltemp + " °C";
            } else {
              document.getElementById("autoThermostat").style = "";
              document.getElementById("thermostatTemp").innerHTML = "Regeltemp: -- °C";
            }
            if (thermostat[7].heating == "Off") {
              document.getElementById("offThermostat").style = "color: black;";
              document.getElementById("onThermostat").style = "";
            } else {
              document.getElementById("onThermostat").style = "color: black;";
              document.getElementById("offThermostat").style = "";
            }
            document.getElementById("roomTemp").innerHTML = "Kamertemp: " + thermostat[7].roomtemp + " °C";
          }
        };
        xhr.send();
      }
      function autoThermostat(event) {
        thermostat[7].manual="Off";
        saveThermostat();
        event.stopPropagation();
      }
      function onThermostat(event) {
        thermostat[7].manual="On";
        thermostat[7].heating="On";
        saveThermostat();
        event.stopPropagation();
      }
      function offThermostat(event) {
        thermostat[7].manual="On";
        thermostat[7].heating="Off";
        saveThermostat();
        event.stopPropagation();
      }
      function resetThermostat(event) {
        event.stopPropagation();
        thermostat = [
        [
            {"time":"07:00", "temp":"20"},
            {"time":"21:40", "temp":"15"},
        ],
        [
            {"time":"07:00", "temp":"20"},
            {"time":"21:40", "temp":"15"},
        ],
        [
            {"time":"07:00", "temp":"20"},
            {"time":"21:40", "temp":"15"},
        ],
        [
            {"time":"07:00", "temp":"20"},
            {"time":"21:40", "temp":"15"},
        ],
        [
            {"time":"07:00", "temp":"20"},
            {"time":"21:40", "temp":"15"},
        ],
        [
            {"time":"07:00", "temp":"20"},
            {"time":"21:40", "temp":"15"},
        ],
        [
            {"time":"07:00", "temp":"20"},
            {"time":"21:40", "temp":"15"},
        ],
            {"manual":"Off", "heating":"Off", "controltemp":"5", "roomtemp":"15"}
        ];
        weeklyThermostat(event);
      }
      function weeklyThermostat(event) {
        document.getElementById("content").innerHTML = '<pre class="terminalbox">Bezig met het ophalen van de Thermostaat...</pre>';
        centerContent();
        event.stopPropagation();
        if (thermostat == "") {
          setTimeout(weeklyThermostat, 1000, event);
          return;
        }
        saveThermostat();
      }
      function remoteCommand(event, command) {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', "bash.sh", true);
        xhr.onload = function(e) {
          if (this.status == 200) {
            document.getElementById("content").innerHTML = '<pre class="terminalbox">Test: ' + this.responseText + "</pre>";
            centerContent();
          }
        };
        xhr.send("encpin=" + encryptedPIN + "&command=" + command);
        document.getElementById("content").innerHTML = '<pre class="terminalbox">Bezig met de ' + command + " opdracht</pre>";
        centerContent();
        event.stopPropagation();
      }
      function system(event) {
        if (encryptedPIN == "") {
          callback=system;
          enterPIN(event);
        } else {
          var xhr = new XMLHttpRequest();
          xhr.open('POST', "bash.sh", true);
          xhr.onload = function(e) {
            if (this.status == 200) {
              document.getElementById("content").innerHTML = this.responseText;
              centerContent();
            }
          };
          xhr.send("encpin=" + encryptedPIN + "&command=system");
          document.getElementById("content").innerHTML = '<pre class="terminalbox">Even geduld...</pre>';
          centerContent();
          event.stopPropagation();
        }
      }
      function fotokader(event) {
        background();
        document.getElementById("content").innerHTML = "";
        event.stopPropagation();
      }
      function menu() {
        clearTimeout(startTimer);
        document.getElementById("content").innerHTML = `<button onclick="fotokader(event);">Fotokader</button>
        <button onclick="startTime(event);">Klok</button>
        <button onclick="hourly=60;weather(event);">Weerbericht</button>
        <button onclick="weeklyThermostat(event);">Thermostaat</button>
        <button onclick="motionDetection(event);">Beweging</button>
        <button onclick="system(event);">Systeem</button>`;
        centerContent();
      }
      window.addEventListener("click", menu);

      var dayNames = new Array("zondag","maandag","dinsdag","woensdag","donderdag","vrijdag","zaterdag");
      var monthNames = new Array("januari","februari","maart","april","mei","juni","juli","augustus","september","oktober","november","december");
      function toLocaleDateString(datumobj) {
        return dayNames[datumobj.getDay()] + '&nbsp;' + datumobj.getDate() + '&nbsp;' + monthNames[datumobj.getMonth()] + '&nbsp;' + datumobj.getFullYear();
      }
      var startTimer;
      function startTime(event) {
        var today = new Date();
        var h = today.getHours();
        var m = today.getMinutes();
        var s = today.getSeconds();
        m = checkTime(m);
        s = checkTime(s);
        document.getElementById('content').innerHTML = '<span id="clock">' + h + ":" + m + ":" + s + '</span><br><span id="date">'+ toLocaleDateString(today) + '</span>';
        centerContent();
        startTimer = setTimeout(startTime, 500);
        event.stopPropagation();
      }
      function checkTime(i) {
        if (i < 10) {i = "0" + i};  // add zero in front of numbers < 10
        return i;
      }
    </script>
  </head>
  <body onload="background();setcursor();">
  <div id="content"></div>
</body>
</html>
